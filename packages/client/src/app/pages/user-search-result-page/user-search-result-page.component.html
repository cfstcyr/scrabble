<app-page-header title="Profil utilisateur" buttonRoute="/search">
    <app-header-btn link="/search" header-button><app-icon icon="search" styling="solid"></app-icon></app-header-btn>
</app-page-header>

<div class="page">
    <div class="page-content">
        <ng-container *ngIf="(error$ | async) as error">
            <mat-card>
                <h2>Erreur</h2>
                <p>{{error}}</p>
            </mat-card>
        </ng-container>
        
        <ng-container *ngIf="(error$ | async) === undefined && (user$ | async) as user">
            <app-user-profile-info
                [avatar]="user.avatar"
                [username]="user.username"
            >
            </app-user-profile-info>

            <mat-card class="user-stats">
                <app-user-profile-stats-item title="Parties jouées" [value]="user.statistics.gamesPlayedCount">
                    <app-icon icon="gamepad" styling="solid" stats-icon></app-icon>
                </app-user-profile-stats-item>
                <app-user-profile-stats-item title="Parties gagnées" [value]="user.statistics.gamesWonCount">
                    <app-icon icon="crown" styling="solid" stats-icon></app-icon>
                </app-user-profile-stats-item>
                <app-user-profile-stats-item title="Moyenne de points" [value]="((user.statistics.averagePointsPerGame| number:'1.0-0') ?? 0) + ' pts'">
                    <app-icon icon="poll-h" styling="solid" stats-icon></app-icon>
                </app-user-profile-stats-item>
                <app-user-profile-stats-item title="Temps moyen" [value]="((user.statistics.averageTimePerGame| number:'1.0-0') ?? 0) + ' s'">
                    <app-icon icon="clock" styling="solid" stats-icon></app-icon>
                </app-user-profile-stats-item>
            </mat-card>

            <mat-card style="padding: 24px">
                <h2>Historique des parties</h2>
                <table 
                    mat-table [dataSource]="gameHistory"
                    class="table"
                >
                    <tr mat-header-row *matHeaderRowDef="gameHistoryColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: gameHistoryColumns;"></tr>
    
                    <ng-container matColumnDef="startTime">
                        <th mat-header-cell *matHeaderCellDef>Début</th>
                        <td mat-cell *matCellDef="let element"> {{element.startTime | date:'d MMMM YYYY, h:mm:ss'}} </td>
                    </ng-container>
    
                    <ng-container matColumnDef="endTime">
                        <th mat-header-cell *matHeaderCellDef>Durée</th>
                        <td mat-cell *matCellDef="let element"> {{(element.endTime.getTime() - element.startTime.getTime()) | duration}}</td>
                    </ng-container>
    
                    <ng-container matColumnDef="gameResult">
                        <th mat-header-cell *matHeaderCellDef>Résultat</th>
                        <td mat-cell *matCellDef="let element">
                            <div *ngIf="element.hasBeenAbandoned" class="game-result game-result--abandoned" matTooltip="Abandonnée">
                                <app-icon icon="pennant" styling="solid"></app-icon>
                            </div>
                            <div *ngIf="!element.hasBeenAbandoned && element.isWinner" class="game-result game-result--winner" matTooltip="Gagnée">
                                <app-icon icon="crown" styling="solid"></app-icon>
                            </div>
                            <div *ngIf="!element.hasBeenAbandoned && !element.isWinner" class="game-result game-result--lost"  matTooltip="Perdue">
                                <app-icon icon="times" styling="solid"></app-icon>
                            </div>
                        </td>
                    </ng-container>
    
                    <ng-container matColumnDef="score">
                        <th mat-header-cell *matHeaderCellDef>Score</th>
                        <td mat-cell *matCellDef="let element"> {{element.score}} pts</td>
                    </ng-container>
                </table>
    
                <mat-paginator [pageSizeOptions]="[5, 10, 20]"
                    showFirstLastButtons
                    #gameHistoryPaginator></mat-paginator>
            </mat-card>
        </ng-container>    
    </div>
</div>

